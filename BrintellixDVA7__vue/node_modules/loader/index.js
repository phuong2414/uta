var utils = require('utils');

exports.load = function(url){
	return cache(url, loadData(url));
};

exports.loadWithoutCache = function(url){
	return loadData(url);
};

exports.loadSync = function(url){
	return cache(url, utils.load(url));
};

exports.loadJSON = function(url, reviver, cache){
	return utils.loadAsync(url, cache)
		.then(function(data){
			return JSON.parse(data, reviver);
		})
		.catch(function(){
			warn(url);
			return {};
		});
};

exports.loadJSONSync = function(url, reviver){
	try{
		return JSON.parse(exports.loadSync(url).responseText, reviver);
	}catch (err){
		warn(url);
		return {};
	}
};

function loadData(url){
	return new Promise(function(resolve, reject){
		utils.load(url, resolve, true);
	})
		.then(function(response){
			return response.target.responseText;
		});
}

function cache(url, value){
	if(cache[url]){
		return cache[url];
	}

	return cache[url] = value;
}

function warn(url){
	console.warn("File can't be loaded or parsed: " + url);
}
