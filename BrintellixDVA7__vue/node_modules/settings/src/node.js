var path = require('path')
var utils = require('utils')
var fs = require('fs')

module.exports = function (options) {
  if (options && options.settings) {
    return initSettings(options.settings, options.structure)
  } else {
    return getSettingsFromFileSystem(options)
  }
}

function getSettingsFromFileSystem (options) {
  var settings, structure

  options = utils.mixin({
    cwd: process.cwd(),
    structure: 'structure.json'
  }, options || {})

  settings = JSON.parse(fs.readFileSync(path.join(path.resolve(options.cwd), 'app/settings/app.json')))
  structure = JSON.parse(fs.readFileSync(path.join(path.resolve(options.cwd), options.structure)))

  return initSettings(settings, structure)
}

function initSettings (settings, structure) {
  var api = require('./api')

  settings._api = api(settings, structure)

  return settings
}
